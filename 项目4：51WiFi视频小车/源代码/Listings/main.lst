C51 COMPILER V9.01   MAIN                                                                  11/21/2020 11:23:03 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\software\keil\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*******************************************
   2          名称：51WIFI视频小车
   3          作者：化作尘
   4          时间：2020年11月20日11点27分
   5          哔哩哔哩项目视频：
   6          csdn博客教程：
   7          邮箱:2809786963@qq.com
   8          *******************************************/
   9          
  10          #include "reg52.h"
  11          
  12          
  13          #define uchar unsigned char
  14          #define uint unsigned char
  15          
  16          
  17          /***小车控制定义**/
  18          #define DIR P1
  19          #define QIAN 0xaa 
  20          #define HOU 0x55 
  21          #define ZUO 0x5a 
  22          #define YOU 0xa5 
  23          #define STOP 0x00 
  24          
  25          
  26          void uart_init();
  27          void uart_tx_string(uchar *str);
  28          void uart_tx_byte(uchar str);
  29          void Delayms(unsigned int n);
  30          void Delayus(unsigned int n);
  31          
  32          uchar rec;//接收到的字节
  33          uchar buff[9]="00000000";//接收到的数据包
  34          uchar flag;//数据包开始接收标志
  35          uchar num; //数组下标
  36          uchar buf_ready;//接收到数据包置1
  37          
  38          /*********************************************************
  39          函数名：主函数
  40          *********************************************************/
  41          void main()
  42          {
  43   1              uart_init();
  44   1              DIR = STOP;
  45   1              Delayms(1);
  46   1              buff[3] = 0x80;
  47   1              buff[4] = 0x80;
  48   1              uart_tx_string("hello buletooch car!\n");
  49   1              while(1)
  50   1              {
  51   2                      if(buf_ready == 1)//接收一组数据完成标志
  52   2                      {
  53   3                            buf_ready = 0;
  54   3                      }
C51 COMPILER V9.01   MAIN                                                                  11/21/2020 11:23:03 PAGE 2   

  55   2                      if(buff[3]>0xb0){DIR = QIAN;Delayus(buff[3]-0xa0);DIR = STOP;Delayus(0x20);}//buff[3]控制前后
  56   2                      else if(buff[3]<0x40){DIR = HOU;Delayus(0x60-buff[3]);DIR = STOP;Delayus(0x20);}
  57   2                      
  58   2                      else if(buff[4]>0xd0){DIR = YOU;Delayus(20);DIR = STOP;Delayus(5);}//buff[4]控制左右
  59   2                      else if(buff[4]<0x20){DIR = ZUO;Delayus(20);DIR = STOP;Delayus(5);}
  60   2                      else DIR = STOP;
  61   2              }
  62   1      }
  63          
  64          /*********************************************************
  65          函数名：串口中断
  66          *********************************************************/
  67          void uart_timer() interrupt 4
  68          {
  69   1              if(RI)
  70   1              {
  71   2                      RI = 0;
  72   2                      rec=SBUF;
  73   2                      
  74   2                      if(rec==0x66 && flag==0)//数据头
  75   2                      {
  76   3                            flag = 1;  
  77   3                            num=0;
  78   3                            buff[0] = rec;
  79   3                      }
  80   2                      else if(flag == 1)//开始接收数据包buff[8]
  81   2                      {
  82   3                        
  83   3                            num++;
  84   3                            buff[num] = rec;
  85   3                            if(num==7 && buff[7]==0x99)//接收到数据尾
  86   3                            {
  87   4                                buf_ready = 1;
  88   4                                flag = 0;
  89   4                                num = 0;
  90   4                            }
  91   3                            else if(num == 7)//接收错误
  92   3                            {
  93   4                                flag = 0;
  94   4                                num = 0;
  95   4                            }
  96   3                      }
  97   2              }
  98   1      }
  99          
 100          /*********************************************************
 101          函数名：串口初始化
 102          波特率：9600
 103          晶振：11.059M
 104          *********************************************************/
 105          void uart_init()
 106          {
 107   1              TMOD=0x20;
 108   1              TH1=0xfd; //9600
 109   1              TL1=0xfd;
 110   1              PCON=0x80;//9600
 111   1              SCON=0x50;
 112   1              TR1=1; //start Timer1
 113   1              EA=1;
 114   1              ES=1;
 115   1      }
 116           
C51 COMPILER V9.01   MAIN                                                                  11/21/2020 11:23:03 PAGE 3   

 117          /*********************************************************
 118          函数名：串口发送一个字节
 119          *********************************************************/
 120          void uart_tx_byte(uchar str)
 121          {
 122   1              SBUF=str;
 123   1              while(!TI);
 124   1              Delayms(2);
 125   1      }
 126          
 127          /*********************************************************
 128          函数名：串口发送一个字符串
 129          *********************************************************/
 130          void uart_tx_string(uchar *str)
 131          {
 132   1              while(*str!='\0')
 133   1              {
 134   2                      uart_tx_byte(*str++);
 135   2                      Delayms(2);
 136   2              }
 137   1      }
 138          
 139          /*********************************************************
 140          函数名：延时函数
 141          *********************************************************/
 142          void Delayms(unsigned int n)
 143          {
 144   1              unsigned int i,j;
 145   1              for(j=n;j>0;j--)
 146   1                      for(i=112;i>0;i--);
 147   1      }
 148          
 149          void Delayus(unsigned int n)
 150          {
 151   1              while(n--);
 152   1      }
 153          
 154          
 155          
 156          
 157          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    345    ----
   CONSTANT SIZE    =     22    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
